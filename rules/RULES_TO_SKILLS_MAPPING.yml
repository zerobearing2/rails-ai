# Rules to Skills Mapping
# Bidirectional linking between TEAM_RULES.md and skills/
# Version: 2.0
# Last updated: 2025-10-30

metadata:
  total_rules: 20
  rules_with_skills: 12  # Includes rule_17 (critical rule, but no implementation skills)
  rules_without_skills: 8
  coverage_percent: 60   # 12/20 = 60% (includes organizational placement in rules_with_skills)

# === RULES BY DOMAIN (Quick Lookup) ===
# Organized by agent specialization for faster rule discovery

rules_by_domain:
  stack_architecture:
    description: "Technology and infrastructure choices"
    rules:
      - rule_1_solid_stack
      - rule_2_minitest
    agents: ["backend"]

  routing:
    description: "URL structure and controller organization"
    rules:
      - rule_3_rest_routes
    agents: ["backend"]

  testing:
    description: "Test methodology and quality standards"
    rules:
      - rule_4_tdd
      - rule_18_webmock
      - rule_19_no_system_tests
    agents: ["tests", "backend", "frontend"]

  frontend:
    description: "UI component and interaction patterns"
    rules:
      - rule_7_turbo_morph
      - rule_13_progressive_enhancement
      - rule_15_viewcomponent
    agents: ["frontend"]

  backend:
    description: "Business logic and data layer organization"
    rules:
      - rule_5_namespacing
      - rule_12_fat_models
    agents: ["backend"]

  workflow:
    description: "Development process and coordination"
    rules:
      - rule_6_architect_review
      - rule_11_draft_prs
      - rule_17_ci_must_pass
    agents: ["architect"]

  philosophy:
    description: "Guiding principles for code quality"
    rules:
      - rule_8_be_concise
      - rule_9_dont_overengineer
      - rule_10_reduce_complexity
      - rule_14_no_premature_optimization
    agents: ["all"]

  code_quality:
    description: "Style and consistency standards"
    rules:
      - rule_16_double_quotes
      - rule_20_hash_dig
    agents: ["all"]
    enforced_by: "rubocop"

# === RULES WITH IMPLEMENTATION SKILLS ===

rules_with_skills:
  # CRITICAL SEVERITY (immediate REJECT)

  rule_1_solid_stack:
    id: 1
    name: "Solid Stack Only"
    severity: critical
    enforcement_action: REJECT
    category: stack_architecture

    violation_triggers:
      keywords: [sidekiq, redis, memcached, resque, delayed_job]
      patterns: ['gem "sidekiq"', 'Redis.new', 'Dalli::Client']

    rejection_response: "We use Rails 8 Solid Stack per TEAM_RULES.md Rule #1"
    redirect_message: "SolidQueue/SolidCache/SolidCable already configured"

    skills:
      primary: solid-stack-setup
      location: "skills/config/solid-stack-setup.md"
      related:
        - skill: action-mailer
          location: "skills/backend/action-mailer.md"
          use_case: "Background email delivery with SolidQueue"

    why: "Rails 8 provides excellent defaults. No external dependencies needed."

  rule_2_minitest:
    id: 2
    name: "Minitest Only"
    severity: critical
    enforcement_action: REJECT
    category: testing

    violation_triggers:
      keywords: [rspec, describe, context, let, subject, before, it]
      patterns: ['gem "rspec-rails"', 'RSpec.describe', 'context "when"']

    rejection_response: "We use Minitest only per TEAM_RULES.md Rule #2"
    redirect_message: "Delegating to @tests to help with Minitest"

    skills:
      primary: tdd-minitest
      location: "skills/testing/tdd-minitest.md"
      related:
        - skill: fixtures-test-data
          location: "skills/testing/fixtures-test-data.md"
        - skill: minitest-mocking
          location: "skills/testing/minitest-mocking.md"
        - skill: test-helpers
          location: "skills/testing/test-helpers.md"

    why: "Minitest is simple, fast, and part of Ruby stdlib. RSpec adds unnecessary complexity."

  rule_3_rest_routes:
    id: 3
    name: "REST Routes Only"
    severity: critical
    enforcement_action: REJECT
    category: routing

    violation_triggers:
      keywords: [member, collection, custom action]
      patterns: ['member do', 'collection do', 'post :publish', 'get :archive']

    rejection_response: "We use RESTful resources only per TEAM_RULES.md Rule #3"
    redirect_message: "Create nested child controller (e.g., Feedbacks::PublicationsController in app/controllers/feedbacks/)"

    skills:
      primary: controller-restful
      location: "skills/backend/controller-restful.md"
      alternative: nested-resources
      alternative_location: "skills/backend/nested-resources.md"
      alternative_note: "Show this as the solution to custom actions"

    why: "REST forces good design - custom actions are code smells"

  rule_4_tdd:
    id: 4
    name: "TDD Always"
    severity: critical
    enforcement_action: REJECT
    category: testing

    violation_triggers:
      keywords: [skip tests, tests later, no tests, no tests needed, write tests after]
      patterns: ['# TODO: add tests', 'skip "not implemented"', 'code without tests']

    rejection_response: "TDD is mandatory per TEAM_RULES.md Rule #4"
    redirect_message: "Tests must be written FIRST (RED-GREEN-REFACTOR cycle)"

    skills:
      primary: tdd-minitest
      location: "skills/testing/tdd-minitest.md"
      related:
        - skill: model-testing-advanced
          location: "skills/testing/model-testing-advanced.md"
          use_case: "Comprehensive model testing"
        - skill: viewcomponent-testing
          location: "skills/testing/viewcomponent-testing.md"
          use_case: "Component testing"
        - skill: fixtures-test-data
          location: "skills/testing/fixtures-test-data.md"
          use_case: "Test data setup"

    why: "Tests written first are better tests. Tests written after are often skipped or incomplete."

  rule_18_webmock:
    id: 18
    name: "WebMock: No Live HTTP in Tests"
    severity: critical
    enforcement_action: REJECT
    category: testing

    violation_triggers:
      keywords: [live http, external request in test, disable webmock, allow real http]
      patterns: ['WebMock.allow_net_connect!', 'making real API calls in tests']

    rejection_response: "Use WebMock to stub external requests per Rule #18"
    redirect_message: "Load minitest-mocking skill for WebMock patterns"

    skills:
      primary: minitest-mocking
      location: "skills/testing/minitest-mocking.md"
      note: "Contains WebMock patterns and examples"

    why: "Tests must be fast, reliable, and not dependent on external services. Live HTTP = flaky tests."

  rule_17_ci_must_pass:
    id: 17
    name: "bin/ci Must Pass"
    severity: critical
    enforcement_action: REJECT
    category: workflow

    violation_triggers:
      keywords: [skip ci, fix later, ignore warnings, bypass ci]
      patterns: ['skip CI checks', 'merge without CI', 'ignore test failures']

    rejection_response: "All changes must pass bin/ci before merging per Rule #17"
    redirect_message: "Run bin/ci locally to fix issues. CI enforces all quality checks."

    why: "Consistent quality standards. bin/ci runs all linters and tests - everything must pass."

  # HIGH SEVERITY (strong SUGGEST)

  rule_7_turbo_morph:
    id: 7
    name: "Turbo Morph by Default"
    severity: high
    enforcement_action: SUGGEST
    category: frontend

    violation_triggers:
      keywords: [turbo frame without reason, replace entire content]
      patterns: ['turbo_frame_tag without justification']

    suggestion_response: "Use Turbo Morph by default per TEAM_RULES.md Rule #7"

    skills:
      primary: turbo-page-refresh
      location: "skills/frontend/turbo-page-refresh.md"
      alternative: hotwire-turbo
      alternative_location: "skills/frontend/hotwire-turbo.md"
      alternative_note: "When Turbo Frames justified (modals, inline editing, tabs)"

    why: "Turbo Morph preserves scroll, focus, and state. Frames replace content and lose state."

  rule_15_viewcomponent:
    id: 15
    name: "ViewComponent for All UI"
    severity: high
    enforcement_action: SUGGEST
    category: frontend

    violation_triggers:
      keywords: [partial for reusable component, helper for complex UI]
      patterns: ['Partials used as components', 'complex helpers rendering HTML']

    suggestion_response: "Use ViewComponent for reusable UI per Rule #15"

    skills:
      primary: viewcomponent-basics
      location: "skills/frontend/viewcomponent-basics.md"
      related:
        - skill: viewcomponent-slots
          location: "skills/frontend/viewcomponent-slots.md"
        - skill: viewcomponent-variants
          location: "skills/frontend/viewcomponent-variants.md"
        - skill: viewcomponent-previews
          location: "skills/frontend/viewcomponent-previews.md"
        - skill: viewcomponent-testing
          location: "skills/testing/viewcomponent-testing.md"

    why: "ViewComponents are testable, performant (10x faster than partials), and encapsulated."

  # MODERATE SEVERITY (suggest)

  rule_5_namespacing:
    id: 5
    name: "Proper Namespacing"
    severity: moderate
    enforcement_action: SUGGEST
    category: code_quality

    violation_triggers:
      keywords: [flat namespace, unclear naming]
      patterns: ['overly nested (3+ levels)', 'conflicting names']

    skills:
      primary: concerns-models
      location: "skills/backend/concerns-models.md"
      related:
        - skill: activerecord-patterns
          location: "skills/backend/activerecord-patterns.md"
        - skill: concerns-controllers
          location: "skills/backend/concerns-controllers.md"
        - skill: nested-resources
          location: "skills/backend/nested-resources.md"

    why: "Clear organization, prevents naming conflicts, maintainable structure."

  rule_12_fat_models:
    id: 12
    name: "Fat Models, Thin Controllers"
    severity: moderate
    enforcement_action: SUGGEST
    category: code_quality

    violation_triggers:
      keywords: [controller with business logic, controller over 100 lines]
      patterns: ['Complex conditional logic in controllers']

    suggestion_response: "Extract to form/query object per Rule #12"

    skills:
      primary: antipattern-fat-controllers
      location: "skills/backend/antipattern-fat-controllers.md"
      note: "Identifies violations and refactoring patterns"
      related:
        - skill: form-objects
          location: "skills/backend/form-objects.md"
          use_case: "Extract complex form logic"
        - skill: query-objects
          location: "skills/backend/query-objects.md"
          use_case: "Extract complex queries"
        - skill: concerns-controllers
          location: "skills/backend/concerns-controllers.md"
          use_case: "Extract shared behavior"

    why: "Controllers should coordinate, not contain business logic. Logic in models is easier to test and reuse."

  rule_13_progressive_enhancement:
    id: 13
    name: "Progressive Enhancement"
    severity: moderate
    enforcement_action: SUGGEST
    category: frontend

    violation_triggers:
      keywords: [requires javascript, doesn't work without js]
      patterns: ['Features that fail without JavaScript']

    skills:
      primary: hotwire-turbo
      location: "skills/frontend/hotwire-turbo.md"
      note: "Server-rendered interactivity"
      related:
        - skill: accessibility-patterns
          location: "skills/frontend/accessibility-patterns.md"
          note: "Keyboard navigation and fallbacks"

    why: "Accessibility, reliability, broader device support. JavaScript enhances, doesn't enable."

  rule_20_hash_dig:
    id: 20
    name: "Hash#dig for Nested Access"
    severity: moderate
    enforcement_action: SUGGEST
    category: code_quality

    violation_triggers:
      keywords: [nested bracket access, chained fetch, "hash[:a][:b]"]
      patterns: ['hash[:a][:b][:c]', 'hash.fetch(:a).fetch(:b)', 'unsafe nested access']

    suggestion_response: "Use Hash#dig for safe nested access per Rule #20"

    skills:
      primary: rubocop-setup
      location: "skills/config/rubocop-setup.md"
      note: "RuboCop enforces Style/HashFetchChain and Style/DigChain"

    enforced_by: "rubocop"
    why: "Hash#dig returns nil safely instead of raising NoMethodError. More readable and maintainable than chained bracket access."

# === RULES WITHOUT IMPLEMENTATION SKILLS ===
# These are governance, workflow, philosophy, or style rules

rules_without_skills:
  rule_6_architect_review:
    id: 6
    name: "Architect Reviews Everything"
    severity: high
    type: workflow
    category: workflow
    has_skill: false
    reason: "Process/workflow rule - coordinator workflow, not technical implementation"

  rule_8_be_concise:
    id: 8
    name: "Be Concise"
    severity: moderate
    type: philosophy
    category: code_quality
    has_skill: false
    reason: "Philosophy/principle - applies across all code, not specific pattern"

  rule_9_dont_overengineer:
    id: 9
    name: "Don't Over-Engineer"
    severity: moderate
    type: philosophy
    category: code_quality
    has_skill: false
    reason: "Philosophy/principle - YAGNI applies everywhere"

  rule_10_reduce_complexity:
    id: 10
    name: "Reduce Complexity Always"
    severity: moderate
    type: philosophy
    category: code_quality
    has_skill: false
    reason: "Philosophy/principle - simplicity over cleverness"

  rule_11_draft_prs:
    id: 11
    name: "Draft PRs & Code Reviews"
    severity: high
    type: workflow
    category: workflow
    has_skill: false
    reason: "Process/workflow rule - Git workflow, not code pattern"

  rule_14_no_premature_optimization:
    id: 14
    name: "No Premature Optimization"
    severity: moderate
    type: philosophy
    category: performance
    has_skill: false
    reason: "Philosophy/principle - optimize what you measure"

  rule_16_double_quotes:
    id: 16
    name: "Double Quotes Always"
    severity: low
    type: style
    category: code_quality
    has_skill: false
    enforced_by: rubocop
    reason: "Style preference - Enforced by rubocop, not manual skill"

  rule_19_no_system_tests:
    id: 19
    name: "No System Tests (Deprecated)"
    severity: moderate
    type: deprecation
    category: testing
    has_skill: false
    reason: "Deprecation guidance - use integration tests instead"

# === ENFORCEMENT PATTERNS ===

enforcement_patterns:
  critical_rules:
    rules: [1, 2, 3, 4, 17, 18]
    action: REJECT
    process: "Immediate rejection with redirect to compliant alternative"
    skill_loading: required

  high_rules:
    rules: [6, 7, 11, 15]
    action: SUGGEST_STRONGLY
    process: "Strong recommendation with explanation"
    skill_loading: recommended
    exceptions: "Allow with justification in rare cases"

  moderate_rules:
    rules: [5, 8, 9, 10, 12, 13, 14, 16, 19, 20]
    action: SUGGEST
    process: "Recommend best practice, guide toward better approach"
    skill_loading: optional

# === QUICK KEYWORD LOOKUP ===

keyword_to_rule:
  sidekiq: rule_1_solid_stack
  redis: rule_1_solid_stack
  memcached: rule_1_solid_stack
  resque: rule_1_solid_stack
  delayed_job: rule_1_solid_stack

  rspec: rule_2_minitest
  describe: rule_2_minitest
  context: rule_2_minitest
  let: rule_2_minitest
  subject: rule_2_minitest

  member: rule_3_rest_routes
  collection: rule_3_rest_routes
  "custom action": rule_3_rest_routes

  "skip tests": rule_4_tdd
  "tests later": rule_4_tdd
  "no tests": rule_4_tdd

  "turbo_frame_tag": rule_7_turbo_morph
  "turbo frame": rule_7_turbo_morph

  "service object": rule_9_dont_overengineer
  "validator service": rule_9_dont_overengineer
  "complex abstraction": rule_9_dont_overengineer
  presenter: rule_9_dont_overengineer

  "controller > 100 lines": rule_12_fat_models
  "business logic in controller": rule_12_fat_models

  "premature optimization": rule_14_no_premature_optimization
  "just in case": rule_14_no_premature_optimization

  "partial as component": rule_15_viewcomponent
  "complex helper": rule_15_viewcomponent

  "live http": rule_18_webmock
  "external request in test": rule_18_webmock
  "disable webmock": rule_18_webmock

  "applicationsystemtestcase": rule_19_no_system_tests
  "system test": rule_19_no_system_tests

  "nested bracket access": rule_20_hash_dig
  "chained fetch": rule_20_hash_dig

# === USAGE INSTRUCTIONS FOR AGENTS ===

usage_instructions:
  for_coordinator:
    when_violation_detected:
      - "Check keyword_to_rule mapping for violated rule"
      - "Load rule details from rules_with_skills section"
      - "Execute enforcement_action (REJECT or SUGGEST)"
      - "Load primary skill from skills.primary"
      - "Reference skill location for implementation details"
      - "Use rejection_response or suggestion_response verbatim"
      - "Show redirect_message with skill path"
      - "Explain why with reason from 'why' field"

    when_recommending_skills:
      - "Check if task relates to any team rules"
      - "Load related skills from rules_with_skills"
      - "Mention which rule the skill enforces"
      - "Prioritize critical rules first"

  for_specialized_agents:
    on_skill_load:
      - "Check skill YAML front matter for enforces_team_rule"
      - "Note which rules this skill helps enforce"
      - "Apply patterns while being aware of rule context"
      - "Reference rule for 'why' this pattern matters"

# === STATISTICS ===

statistics:
  rules_by_severity:
    critical: 6
    high: 4
    moderate: 9
    low: 1

  rules_by_type:
    technology: 4
    pattern: 6
    workflow: 4
    philosophy: 4
    style: 2

  skill_enforcement_coverage:
    all_security_rules: "No skills (enforced by Rails defaults + team awareness)"
    all_testing_rules: "Full coverage (3/3 rules have skills)"
    all_frontend_rules: "Full coverage (2/2 rules have skills)"
    all_backend_rules: "Partial coverage (3/5 rules have skills)"
    all_workflow_rules: "No coverage (0/4 - by design, these are process rules)"

version_history:
  - version: 2.0
    date: 2025-10-30
    changes: "Enhanced with enforcement patterns, keyword lookup, usage instructions"
  - version: 1.0
    date: 2025-10-30
    changes: "Initial mapping created during refactor"
