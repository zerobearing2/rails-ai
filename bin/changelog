#!/usr/bin/env bash
# Rails AI Changelog Generator
# Generates Keep a Changelog formatted entries from git commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print success message
print_success() {
  echo -e "${GREEN}✅ $1${NC}"
}

# Print error message
print_error() {
  echo -e "${RED}❌ $1${NC}"
}

# Print warning message
print_warning() {
  echo -e "${YELLOW}⚠️  $1${NC}"
}

# Print info message
print_info() {
  echo -e "${BLUE}ℹ️  $1${NC}"
}

# Non-interactive mode flag
NON_INTERACTIVE=false
if [ "$1" = "--non-interactive" ] || [ "$1" = "-n" ]; then
  NON_INTERACTIVE=true
fi

# Welcome message (skip in non-interactive mode)
if [ "$NON_INTERACTIVE" = false ]; then
  echo ""
  echo -e "${BLUE}╔═══════════════════════════════════════════╗${NC}"
  echo -e "${BLUE}║    Rails AI - Changelog Generator        ║${NC}"
  echo -e "${BLUE}╚═══════════════════════════════════════════╝${NC}"
  echo ""
fi

# Get last version tag
LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
if [ -z "$LAST_TAG" ]; then
  print_warning "No previous tags found"
  LAST_TAG="HEAD~10"  # Use last 10 commits if no tags
else
  print_info "Last tag: $LAST_TAG"
fi

# Get commit log with formatting
print_info "Analyzing commits since $LAST_TAG..."
COMMIT_LOG=$(git log $LAST_TAG..HEAD --pretty=format:"- %s" --no-merges)

if [ -z "$COMMIT_LOG" ]; then
  print_warning "No commits found since last version"
  COMMIT_LOG="- No changes"
fi

echo ""
echo "Commits since last version:"
echo "$COMMIT_LOG"
echo ""

# Check if Claude CLI is available
CLAUDE_CLI_AVAILABLE=false
if command -v claude &> /dev/null; then
  CLAUDE_CLI_AVAILABLE=true
  print_info "Claude CLI detected - will use AI for summarization"
else
  print_warning "Claude CLI not found - will use manual entry"
  print_info "Install Claude CLI for AI-powered summaries: npm install -g @anthropic-ai/claude-code"
fi

# Generate changelog entry
if [ "$CLAUDE_CLI_AVAILABLE" = true ]; then
  print_info "Using Claude CLI to generate changelog entry..."

  # Create prompt for Claude
  CLAUDE_PROMPT="Analyze these git commits and generate a concise CHANGELOG entry in Keep a Changelog format.

Commits:
$COMMIT_LOG

Instructions:
- Use categories: Added, Changed, Fixed, Removed, Security, Deprecated
- Be concise but informative
- Focus on user-facing changes
- Omit internal refactors unless significant
- Use bullet points
- No intro/outro text, just the categorized bullets
- Only include categories that have changes

Example format:
### Added
- New feature X for Y

### Fixed
- Bug in Z component"

  # Call Claude CLI and capture output
  CHANGELOG_ENTRY=$(echo "$CLAUDE_PROMPT" | claude --print 2>/dev/null || echo "")

  if [ -z "$CHANGELOG_ENTRY" ]; then
    print_warning "Claude CLI failed to generate entry, falling back to manual"
    CLAUDE_CLI_AVAILABLE=false
  else
    print_success "Generated changelog entry with Claude CLI"
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "$CHANGELOG_ENTRY"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Skip interactive prompt in non-interactive mode
    if [ "$NON_INTERACTIVE" = false ]; then
      read -p "Use this changelog entry? (y/n/e to edit) " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Ee]$ ]]; then
        print_info "Opening editor for changelog entry..."
        TEMP_FILE=$(mktemp)
        echo "$CHANGELOG_ENTRY" > "$TEMP_FILE"
        ${EDITOR:-vim} "$TEMP_FILE"
        CHANGELOG_ENTRY=$(cat "$TEMP_FILE")
        rm "$TEMP_FILE"
      elif [[ ! $REPLY =~ ^[Yy]$ ]]; then
        CLAUDE_CLI_AVAILABLE=false
      fi
    fi
  fi
fi

# Manual entry if Claude not available or user declined (skip in non-interactive)
if [ "$CLAUDE_CLI_AVAILABLE" = false ]; then
  if [ "$NON_INTERACTIVE" = true ]; then
    print_error "Cannot generate changelog: Claude CLI unavailable and running in non-interactive mode"
    exit 1
  fi

  print_info "Enter changelog entry manually (or press Ctrl+C to cancel)"
  echo "Use Keep a Changelog format (Added, Changed, Fixed, etc.)"
  echo "Press Ctrl+D when done"
  echo ""
  CHANGELOG_ENTRY=$(cat)
fi

if [ -z "$CHANGELOG_ENTRY" ]; then
  print_error "Changelog entry cannot be empty"
  exit 1
fi

# Output the changelog entry
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Final Changelog Entry:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "$CHANGELOG_ENTRY"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Save to temp file for bin/release to use
OUTPUT_FILE="${TMPDIR:-/tmp}/rails-ai-changelog-entry.txt"
echo "$CHANGELOG_ENTRY" > "$OUTPUT_FILE"
print_success "Changelog entry saved to: $OUTPUT_FILE"
echo ""
print_info "This entry can be used by bin/release or manually added to CHANGELOG.md"
