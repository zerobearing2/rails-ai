<%# Hotwire Turbo Comprehensive Patterns %>
<%# Reference: Rails Guides - Working with JavaScript %>
<%# Category: FRONTEND - HOTWIRE/TURBO %>

<%#
============================================================================
What is Hotwire Turbo?
============================================================================

Turbo is part of Hotwire and provides:
- Turbo Drive: Accelerates page navigation (like Turbolinks)
- Turbo Frames: Scoped page updates without full reload
- Turbo Streams: Real-time partial page updates via WebSockets or HTTP
- Turbo Morph: Intelligent page morphing (preserves scroll, focus, state)

Benefits:
✅ Fast, SPA-like navigation without JavaScript framework
✅ Progressively enhanced
✅ Server-rendered HTML
✅ Real-time updates
✅ Mobile-friendly
%>

<%#
============================================================================
✅ TURBO DRIVE - Automatic Page Acceleration
============================================================================
%>

<%# Turbo Drive is automatically enabled, no setup needed %>
<%# It intercepts link clicks and form submissions %>

<%# Regular link - accelerated by Turbo Drive %>
<%= link_to "View Feedback", feedback_path(@feedback) %>

<%# Disable Turbo for specific link %>
<%= link_to "Download PDF", feedback_pdf_path(@feedback), data: { turbo: false } %>

<%# Force full page reload %>
<%= link_to "Admin Panel", admin_path, data: { turbo: "false" } %>

<%# Replace instead of push (no browser history entry) %>
<%= link_to "Dismiss", dismiss_path, data: { turbo_action: "replace" } %>

<%#
============================================================================
✅ TURBO FRAMES - Scoped Updates
============================================================================
%>

<%# Basic Turbo Frame %>
<%= turbo_frame_tag "feedback_#{@feedback.id}" do %>
  <div class="feedback-card">
    <h3><%= @feedback.content %></h3>
    <%= link_to "Edit", edit_feedback_path(@feedback) %>
  </div>
<% end %>

<%# Turbo Frame with custom ID %>
<%= turbo_frame_tag "modal" do %>
  <%# Frame content %>
<% end %>

<%# Lazy-loading Turbo Frame %>
<%= turbo_frame_tag "lazy_content", src: lazy_content_path, loading: :lazy do %>
  <p>Loading...</p>
<% end %>

<%# Target another frame (break out of frame) %>
<%= turbo_frame_tag "feedback_form" do %>
  <%= form_with model: @feedback, data: { turbo_frame: "_top" } do |form| %>
    <%# Submits to entire page, not just frame %>
    <%= form.text_area :content %>
    <%= form.submit %>
  <% end %>
<% end %>

<%# Nested Turbo Frames %>
<%= turbo_frame_tag "feedbacks_list" do %>
  <% @feedbacks.each do |feedback| %>
    <%= turbo_frame_tag dom_id(feedback) do %>
      <%= render "feedback", feedback: feedback %>
    <% end %>
  <% end %>
<% end %>

<%# Turbo Frame for modals %>
<%= turbo_frame_tag "modal", target: "_top" do %>
  <div class="modal">
    <%= link_to "Close", "#", data: { turbo_frame: "_top", action: "turbo:submit-end->modal#close" } %>
  </div>
<% end %>

<%#
============================================================================
✅ TURBO STREAMS - Real-time Updates (7 Actions)
============================================================================
%>

<%# 1. APPEND - Add to end %>
<%= turbo_stream.append "feedbacks", @feedback %>
<%= turbo_stream.append "feedbacks" do %>
  <%= render "feedback", feedback: @feedback %>
<% end %>

<%# 2. PREPEND - Add to beginning %>
<%= turbo_stream.prepend "feedbacks", @feedback %>

<%# 3. REPLACE - Replace entire element %>
<%= turbo_stream.replace dom_id(@feedback), @feedback %>
<%= turbo_stream.replace "notification" do %>
  <div class="alert alert-success">Feedback updated!</div>
<% end %>

<%# 4. UPDATE - Replace content only (not element itself) %>
<%= turbo_stream.update "feedback_count", @feedbacks.count %>
<%= turbo_stream.update "feedback_#{@feedback.id}_content" do %>
  <%= @feedback.content %>
<% end %>

<%# 5. REMOVE - Delete element %>
<%= turbo_stream.remove dom_id(@feedback) %>

<%# 6. BEFORE - Insert before element %>
<%= turbo_stream.before "feedback_#{@feedback.id}", partial: "new_feedback" %>

<%# 7. AFTER - Insert after element %>
<%= turbo_stream.after "feedback_#{@feedback.id}", partial: "response" %>

<%# Multiple Turbo Streams in one response %>
<%= turbo_stream.append "feedbacks", @feedback %>
<%= turbo_stream.update "count", @feedbacks.count %>
<%= turbo_stream.replace "notification" do %>
  <div class="alert alert-success">Feedback added!</div>
<% end %>

<%#
============================================================================
✅ TURBO STREAM BROADCASTS (Real-time with ActionCable)
============================================================================
%>

<%# Subscribe to broadcasts in view %>
<%= turbo_stream_from "feedbacks" %>

<%# Subscribe with dynamic channel %>
<%= turbo_stream_from "user_#{current_user.id}_feedbacks" %>

<%# Subscribe to multiple channels %>
<%= turbo_stream_from "feedbacks" %>
<%= turbo_stream_from "notifications" %>

<%# Model broadcasts (in model) %>
<%# class Feedback < ApplicationRecord
  after_create_commit { broadcast_append_to "feedbacks" }
  after_update_commit { broadcast_replace_to "feedbacks" }
  after_destroy_commit { broadcast_remove_to "feedbacks" }
end %>

<%# Custom broadcasts (in controller/job) %>
<%# Turbo::StreamsChannel.broadcast_append_to(
  "feedbacks",
  target: "feedbacks_list",
  partial: "feedbacks/feedback",
  locals: { feedback: @feedback }
) %>

<%#
============================================================================
✅ TURBO MORPH (Rails 8) - Page Refreshes
============================================================================
%>

<%# Turbo Morph is the DEFAULT in Rails 8 %>
<%# Preserves scroll position, focus, and form state %>

<%# Refresh page with Turbo Morph %>
<%= link_to "Refresh", request.path, data: { turbo_action: "replace" } %>

<%# Programmatic refresh %>
<button data-action="click->turbo#refresh">Refresh Page</button>

<%# Opt out of morphing for specific elements %>
<div data-turbo-permanent id="video-player">
  <%# This element won't be replaced during morph %>
</div>

<%# Scroll to top on navigation %>
<%= link_to "Back to Top", "#", data: { turbo_action: "advance", turbo_scroll: "top" } %>

<%#
============================================================================
✅ TURBO FORMS
============================================================================
%>

<%# Basic Turbo-enabled form (default) %>
<%= form_with model: @feedback do |form| %>
  <%= form.text_area :content %>
  <%= form.submit %>
<% end %>

<%# Disable Turbo for specific form %>
<%= form_with model: @feedback, data: { turbo: false } do |form| %>
  <%# Full page reload on submit %>
<% end %>

<%# Form that updates a Turbo Frame %>
<%= turbo_frame_tag "feedback_form" do %>
  <%= form_with model: @feedback, data: { turbo_frame: "feedback_form" } do |form| %>
    <%= form.text_area :content %>
    <%= form.submit %>
  <% end %>
<% end %>

<%# Form with loading state %>
<%= form_with model: @feedback do |form| %>
  <%= form.text_area :content %>
  <%= form.submit "Save", data: { turbo_submits_with: "Saving..." } %>
<% end %>

<%#
============================================================================
✅ TURBO EVENTS (Stimulus Integration)
============================================================================
%>

<%# Listen to Turbo events with Stimulus %>
<div data-controller="feedback"
     data-action="turbo:submit-end->feedback#handleSubmit
                  turbo:before-fetch-request->feedback#showLoading
                  turbo:frame-load->feedback#frameLoaded">

  <%= turbo_frame_tag "feedback" do %>
    <%# Frame content %>
  <% end %>
</div>

<%# Common Turbo events:
  - turbo:before-visit
  - turbo:visit
  - turbo:before-cache
  - turbo:before-render
  - turbo:render
  - turbo:load
  - turbo:submit-start
  - turbo:submit-end
  - turbo:before-fetch-request
  - turbo:before-fetch-response
  - turbo:frame-load
  - turbo:frame-render
%>

<%#
============================================================================
✅ ADVANCED PATTERNS
============================================================================
%>

<%# Confirm dialog before submission %>
<%= form_with model: @feedback, data: { turbo_confirm: "Are you sure?" } do |form| %>
  <%= form.submit "Delete", class: "btn btn-danger" %>
<% end %>

<%# Turbo Stream response in controller %>
<%# def create
  @feedback = Feedback.new(feedback_params)

  respond_to do |format|
    if @feedback.save
      format.turbo_stream {
        render turbo_stream: [
          turbo_stream.append("feedbacks", @feedback),
          turbo_stream.update("count", Feedback.count),
          turbo_stream.replace("form") do
            render partial: "form", locals: { feedback: Feedback.new }
          end
        ]
      }
      format.html { redirect_to @feedback }
    else
      format.turbo_stream {
        render turbo_stream: turbo_stream.replace("form", partial: "form",
          locals: { feedback: @feedback })
      }
      format.html { render :new, status: :unprocessable_entity }
    end
  end
end %>

<%# Lazy load with intersection observer %>
<%= turbo_frame_tag "comments",
  src: feedback_comments_path(@feedback),
  loading: :lazy do %>
  <p>Loading comments...</p>
<% end %>

<%# Pagination with Turbo Frames %>
<%= turbo_frame_tag "feedbacks_page_#{@page}" do %>
  <% @feedbacks.each do |feedback| %>
    <%= render feedback %>
  <% end %>

  <%= turbo_frame_tag "feedbacks_page_#{@page + 1}",
    src: feedbacks_path(page: @page + 1),
    loading: :lazy do %>
    <p>Load more...</p>
  <% end %>
<% end %>

<%#
============================================================================
✅ TESTING TURBO
============================================================================
%>

<%# System test with Turbo %>
<%# test "creates feedback with Turbo" do
  visit new_feedback_path

  within "#new_feedback" do
    fill_in "Content", with: "Test feedback"
    click_button "Create Feedback"
  end

  # Turbo updates page without full reload
  assert_selector "#feedback_#{Feedback.last.id}", text: "Test feedback"
end %>

<%# Test Turbo Stream response %>
<%# test "appends feedback via Turbo Stream" do
  post feedbacks_path,
    params: { feedback: { content: "Test" } },
    as: :turbo_stream

  assert_response :success
  assert_includes response.body, 'turbo-stream action="append"'
  assert_includes response.body, "Test"
end %>

<%#
============================================================================
RULE: Use Turbo Morph by default (Rails 8) for page refreshes
PREFER: Turbo Frames for isolated updates (forms, modals, inline editing)
USE: Turbo Streams for real-time updates and complex multi-target updates
TEST: Always test Turbo features with system tests
ACCESSIBILITY: Ensure Turbo updates announce to screen readers
============================================================================
%>
