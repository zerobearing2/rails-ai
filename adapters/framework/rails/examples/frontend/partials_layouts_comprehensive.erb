<%# Partials and Layouts Comprehensive Patterns %>
<%# Reference: Rails Guides - Layouts and Rendering %>
<%# Category: FRONTEND - VIEWS %>

<%#
============================================================================
What Are Partials and Layouts?
============================================================================

Partials:
- Reusable view fragments prefixed with underscore (_partial.html.erb)
- Extract common UI elements
- Pass local variables
- Can have their own layouts

Layouts:
- Define overall page structure
- Wrap view content with <%= yield %>
- Support nested layouts
- Can have layout-specific content sections

Benefits:
✅ DRY - Don't Repeat Yourself
✅ Maintainability
✅ Consistent UI
✅ Easier testing
%>

<%#
============================================================================
✅ BASIC PARTIALS
============================================================================
%>

<%# Render a partial from same directory %>
<%= render "form" %>
<%# Looks for app/views/feedbacks/_form.html.erb %>

<%# Render a partial from another directory %>
<%= render "shared/header" %>
<%# Looks for app/views/shared/_header.html.erb %>

<%# Render partial with local variables %>
<%= render "feedback", feedback: @feedback %>

<%# Render partial with explicit partial: option %>
<%= render partial: "feedback", locals: { feedback: @feedback } %>

<%# Render partial for each item in collection %>
<%= render partial: "feedback", collection: @feedbacks %>
<%# Creates local variable 'feedback' for each item %>

<%# Render collection shorthand %>
<%= render @feedbacks %>
<%# Automatically looks for app/views/feedbacks/_feedback.html.erb %>

<%# Render collection with custom local variable name %>
<%= render partial: "feedback", collection: @feedbacks, as: :item %>
<%# Creates 'item' instead of 'feedback' %>

<%# Spacer template between collection items %>
<%= render partial: "feedback",
           collection: @feedbacks,
           spacer_template: "feedback_spacer" %>

<%#
============================================================================
✅ PARTIAL EXAMPLE FILES
============================================================================
%>

<%# app/views/feedbacks/_feedback.html.erb %>
<div id="<%= dom_id(feedback) %>" class="card">
  <div class="card-body">
    <h3 class="card-title"><%= feedback.content %></h3>
    <p class="text-sm text-muted">
      Submitted <%= time_ago_in_words(feedback.created_at) %> ago
    </p>

    <div class="card-actions">
      <%= link_to "View", feedback_path(feedback), class: "btn btn-primary" %>
      <%= link_to "Edit", edit_feedback_path(feedback), class: "btn btn-ghost" %>
    </div>
  </div>
</div>

<%# app/views/feedbacks/_form.html.erb %>
<%= form_with model: feedback, class: "space-y-4" do |form| %>
  <%= render "shared/form_errors", object: feedback %>

  <div class="form-control">
    <%= form.label :content, class: "label" %>
    <%= form.text_area :content,
                       class: "textarea textarea-bordered",
                       rows: 5,
                       required: true %>
  </div>

  <div class="form-control">
    <%= form.label :recipient_email, class: "label" %>
    <%= form.email_field :recipient_email,
                         class: "input input-bordered",
                         required: true %>
  </div>

  <div class="form-actions">
    <%= form.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", feedbacks_path, class: "btn btn-ghost" %>
  </div>
<% end %>

<%# app/views/shared/_form_errors.html.erb %>
<% if object.errors.any? %>
  <div class="alert alert-error">
    <h3 class="font-bold">
      <%= pluralize(object.errors.count, "error") %> prohibited this
      <%= object.class.model_name.human.downcase %> from being saved:
    </h3>
    <ul class="list-disc list-inside">
      <% object.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>

<%#
============================================================================
✅ PARTIALS WITH BLOCKS
============================================================================
%>

<%# Partial that yields %>
<%# app/views/shared/_card.html.erb %>
<div class="card <%= local_assigns[:variant] %>">
  <% if local_assigns[:title].present? %>
    <div class="card-header">
      <h3 class="card-title"><%= title %></h3>
    </div>
  <% end %>

  <div class="card-body">
    <%= yield %>
  </div>
</div>

<%# Usage with block %>
<%= render "shared/card", title: "Feedback Details" do %>
  <p><%= @feedback.content %></p>
  <p class="text-muted">
    Submitted by <%= @feedback.sender_name || "Anonymous" %>
  </p>
<% end %>

<%# Partial with multiple content areas %>
<%# app/views/shared/_panel.html.erb %>
<div class="panel">
  <div class="panel-header">
    <%= yield :header %>
  </div>

  <div class="panel-body">
    <%= yield %>
  </div>

  <% if content_for?(:footer) %>
    <div class="panel-footer">
      <%= yield :footer %>
    </div>
  <% end %>
</div>

<%# Usage with content_for %>
<%= render "shared/panel" do %>
  <% content_for :header do %>
    <h2>Feedback List</h2>
  <% end %>

  <%= render @feedbacks %>

  <% content_for :footer do %>
    <%= link_to "View All", feedbacks_path, class: "btn" %>
  <% end %>
<% end %>

<%#
============================================================================
✅ PARTIAL LAYOUTS
============================================================================
%>

<%# Partial can have its own layout %>
<%# app/views/feedbacks/_feedback_with_layout.html.erb %>
<%= render layout: "shared/box" do %>
  <%= render "feedback", feedback: feedback %>
<% end %>

<%# app/views/shared/_box.html.erb %>
<div class="box">
  <%= yield %>
</div>

<%#
============================================================================
✅ APPLICATION LAYOUT
============================================================================
%>

<%# app/views/layouts/application.html.erb %>
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title><%= content_for?(:title) ? yield(:title) : "The Feedback Agent" %></title>

  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_importmap_tags %>

  <%# Custom head content from views %>
  <%= yield :head %>
</head>
<body class="<%= content_for?(:body_class) ? yield(:body_class) : '' %>">
  <%= render "shared/header" %>

  <main class="container mx-auto px-4 py-8">
    <%= render "shared/flash_messages" %>
    <%= yield %>
  </main>

  <%= render "shared/footer" %>

  <%# Scripts at end of body %>
  <%= yield :scripts %>
</body>
</html>

<%#
============================================================================
✅ CONTENT_FOR - Define Content in Views
============================================================================
%>

<%# app/views/feedbacks/show.html.erb %>
<% content_for :title do %>
  <%= @feedback.content.truncate(60) %> | The Feedback Agent
<% end %>

<% content_for :head do %>
  <meta name="description" content="<%= @feedback.content.truncate(160) %>">
  <%= auto_discovery_link_tag :rss, feedbacks_path(format: :rss) %>
<% end %>

<% content_for :body_class, "feedback-page" %>

<div class="feedback-detail">
  <h1><%= @feedback.content %></h1>
  <%# ... rest of content ... %>
</div>

<% content_for :scripts do %>
  <script>
    console.log("Custom page script");
  </script>
<% end %>

<%#
============================================================================
✅ NESTED LAYOUTS
============================================================================
%>

<%# app/views/layouts/admin.html.erb %>
<%= render template: "layouts/application" do %>
  <div class="admin-layout">
    <%= render "admin/sidebar" %>

    <div class="admin-content">
      <%= yield %>
    </div>
  </div>
<% end %>

<%# Alternative: Inherit from another layout %>
<%# app/controllers/admin/base_controller.rb %>
<%# class Admin::BaseController < ApplicationController
  layout "admin"
end %>

<%#
============================================================================
✅ CONDITIONAL LAYOUTS
============================================================================
%>

<%# Dynamic layout selection in controller %>
<%# class FeedbacksController < ApplicationController
  layout :choose_layout

  private

  def choose_layout
    if request.xhr?
      false  # No layout for AJAX requests
    elsif current_user&.admin?
      "admin"
    else
      "application"
    end
  end
end %>

<%# Per-action layout %>
<%# class FeedbacksController < ApplicationController
  layout "special", only: [:show, :edit]
end %>

<%#
============================================================================
✅ PARTIAL COLLECTIONS WITH COUNTERS
============================================================================
%>

<%# app/views/feedbacks/_feedback.html.erb %>
<div class="feedback" data-index="<%= feedback_counter %>">
  <span class="badge"><%= feedback_counter + 1 %></span>
  <%= feedback.content %>

  <% if feedback_iteration.first? %>
    <span class="label">First</span>
  <% end %>

  <% if feedback_iteration.last? %>
    <span class="label">Last</span>
  <% end %>
</div>

<%# feedback_counter: 0-indexed counter %>
<%# feedback_iteration: Iteration object with first?, last?, index, size %>

<%#
============================================================================
✅ SHARED PARTIALS
============================================================================
%>

<%# app/views/shared/_header.html.erb %>
<header class="navbar bg-base-100">
  <div class="navbar-start">
    <%= link_to "The Feedback Agent", root_path, class: "btn btn-ghost text-xl" %>
  </div>

  <div class="navbar-center">
    <nav class="menu menu-horizontal">
      <%= link_to "Feedbacks", feedbacks_path, class: "menu-item" %>
      <%= link_to "About", about_path, class: "menu-item" %>
    </nav>
  </div>

  <div class="navbar-end">
    <% if user_signed_in? %>
      <%= link_to "Sign Out", sign_out_path, class: "btn btn-ghost" %>
    <% else %>
      <%= link_to "Sign In", sign_in_path, class: "btn btn-primary" %>
    <% end %>
  </div>
</header>

<%# app/views/shared/_footer.html.erb %>
<footer class="footer footer-center p-10 bg-base-200 text-base-content">
  <div>
    <p class="font-bold">The Feedback Agent</p>
    <p>Copyright © <%= Date.current.year %> - All rights reserved</p>
  </div>

  <nav>
    <%= link_to "Privacy", privacy_path %>
    <%= link_to "Terms", terms_path %>
    <%= link_to "Contact", contact_path %>
  </nav>
</footer>

<%# app/views/shared/_flash_messages.html.erb %>
<% flash.each do |type, message| %>
  <div class="alert alert-<%= alert_type(type) %> mb-4" role="alert">
    <span><%= message %></span>
  </div>
<% end %>

<%#
============================================================================
✅ EMPTY STATE PARTIALS
============================================================================
%>

<%# app/views/shared/_empty_state.html.erb %>
<div class="empty-state text-center py-12">
  <%= image_tag "empty-state.svg", alt: "No items", class: "mx-auto mb-4", width: 200 %>

  <h3 class="text-2xl font-bold mb-2">
    <%= local_assigns[:title] || "No items found" %>
  </h3>

  <p class="text-muted mb-6">
    <%= local_assigns[:message] || "Get started by creating a new item" %>
  </p>

  <% if local_assigns[:action_url] && local_assigns[:action_text] %>
    <%= link_to action_text, action_url, class: "btn btn-primary" %>
  <% end %>
</div>

<%# Usage %>
<% if @feedbacks.empty? %>
  <%= render "shared/empty_state",
             title: "No feedback yet",
             message: "Submit your first feedback to get started",
             action_url: new_feedback_path,
             action_text: "Create Feedback" %>
<% else %>
  <%= render @feedbacks %>
<% end %>

<%#
============================================================================
✅ LOADING STATE PARTIALS
============================================================================
%>

<%# app/views/shared/_loading_spinner.html.erb %>
<div class="flex justify-center items-center <%= local_assigns[:class] %>">
  <span class="loading loading-spinner loading-lg"></span>
  <% if local_assigns[:message].present? %>
    <span class="ml-2"><%= message %></span>
  <% end %>
</div>

<%# Usage in Turbo Frame %>
<%= turbo_frame_tag "feedbacks", src: feedbacks_path do %>
  <%= render "shared/loading_spinner", message: "Loading feedbacks..." %>
<% end %>

<%#
============================================================================
✅ COLLECTION WITH FALLBACK
============================================================================
%>

<%# Render collection or fallback %>
<%= render(@feedbacks) || render("shared/empty_state") %>

<%# Render collection with separator %>
<%= render partial: "feedback",
           collection: @feedbacks,
           spacer_template: "separator" %>

<%# app/views/feedbacks/_separator.html.erb %>
<hr class="my-4">

<%#
============================================================================
✅ TESTING PARTIALS
============================================================================
%>

<%# test/views/feedbacks/_feedback_test.rb %>
<%# require "test_helper"

class Feedbacks::FeedbackPartialTest < ActionView::TestCase
  test "renders feedback content" do
    feedback = feedbacks(:one)

    render partial: "feedbacks/feedback", locals: { feedback: feedback }

    assert_select "div.card"
    assert_select "h3", text: feedback.content
    assert_select "a[href=?]", feedback_path(feedback)
  end

  test "shows AI badge for AI-improved feedback" do
    feedback = feedbacks(:ai_improved)

    render partial: "feedbacks/feedback", locals: { feedback: feedback }

    assert_select ".badge", text: /AI/
  end
end %>

<%#
============================================================================
RULE: Prefix partial filenames with underscore (_partial.html.erb)
PREFER: Local variables over instance variables in partials
USE: Partials for DRY views, layouts for page structure
TEST: Test complex partials with ActionView::TestCase
ORGANIZE: Keep shared partials in app/views/shared/
CACHE: Use fragment caching for expensive partials
============================================================================
%>
