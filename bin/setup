#!/usr/bin/env bash
# Rails AI Setup Script
# Sets up the project for development

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print section header
print_section() {
  echo ""
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Print success message
print_success() {
  echo -e "${GREEN}âœ… $1${NC}"
}

# Print info message
print_info() {
  echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Welcome message
echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘       Rails AI - Setup Script            â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check Ruby version
print_section "ğŸ” Checking Ruby Version"
if command -v ruby &> /dev/null; then
  RUBY_VERSION=$(ruby -v)
  print_info "$RUBY_VERSION"

  RUBY_MAJOR=$(ruby -e 'puts RUBY_VERSION.split(".")[0..1].join(".")')
  if (( $(echo "$RUBY_MAJOR >= 3.3" | bc -l) )); then
    print_success "Ruby version is compatible"
  else
    echo "âš ï¸  Warning: Ruby 3.3+ recommended, you have $RUBY_MAJOR"
  fi
else
  echo "âŒ Ruby not found. Please install Ruby 3.3+"
  exit 1
fi

# Check Bundler
print_section "ğŸ“¦ Checking Bundler"
if command -v bundle &> /dev/null; then
  BUNDLER_VERSION=$(bundle -v)
  print_info "$BUNDLER_VERSION"
  print_success "Bundler installed"
else
  print_info "Installing Bundler..."
  gem install bundler
  print_success "Bundler installed"
fi

# Install dependencies
print_section "ğŸ“¦ Installing Dependencies"
print_info "Running bundle install..."
bundle install
print_success "Dependencies installed"

# Verify installation
print_section "ğŸ§ª Verifying Installation"

print_info "Checking Minitest..."
if bundle exec ruby -e "require 'minitest'" 2>/dev/null; then
  print_success "Minitest available"
else
  echo "âŒ Minitest not available"
  exit 1
fi

print_info "Checking Rubocop..."
if bundle exec rubocop --version &>/dev/null; then
  print_success "Rubocop available"
else
  echo "âŒ Rubocop not available"
  exit 1
fi

# Run quick test
print_section "ğŸ§ª Running Quick Test"
print_info "Running unit tests..."
if bundle exec rake test:unit; then
  print_success "Unit tests passed"
else
  echo "âŒ Unit tests failed"
  exit 1
fi

# Summary
print_section "âœ… Setup Complete!"

echo ""
echo "You're all set! Next steps:"
echo ""
echo "  bin/ci                           # Run full CI pipeline"
echo "  rake test:unit                   # Run all unit tests"
echo "  rake test:unit:skills            # Run skill unit tests only"
echo "  rake lint                        # Run linters"
echo "  rake -T                          # See all tasks"
echo ""
echo "See docs/development-setup.md for more information."
echo ""
