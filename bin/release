#!/usr/bin/env bash
# Rails AI Release Script
# Automates version bumping, changelog updates, tagging, and GitHub release creation

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print section header
print_section() {
  echo ""
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Print success message
print_success() {
  echo -e "${GREEN}âœ… $1${NC}"
}

# Print error message
print_error() {
  echo -e "${RED}âŒ $1${NC}"
}

# Print warning message
print_warning() {
  echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Print info message
print_info() {
  echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Check if we're in the right directory
if [ ! -f "Gemfile" ]; then
  print_error "Gemfile not found. Please run this script from the project root."
  exit 1
fi

# Check if gh CLI is installed
if ! command -v gh &> /dev/null; then
  print_error "GitHub CLI (gh) not installed. Install: https://cli.github.com/"
  exit 1
fi

# Check if gh is authenticated
if ! gh auth status &> /dev/null; then
  print_error "GitHub CLI not authenticated. Run: gh auth login"
  exit 1
fi

# Welcome message
echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘       Rails AI - Release Script          â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check for uncommitted changes
if [ -n "$(git status --porcelain)" ]; then
  print_error "You have uncommitted changes. Please commit or stash them first."
  git status --short
  exit 1
fi

# Make sure we're on main/master branch
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "master" ] && [ "$CURRENT_BRANCH" != "main" ]; then
  print_warning "You're on branch '$CURRENT_BRANCH', not master/main"
  read -p "Continue anyway? (y/n) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_info "Release cancelled"
    exit 1
  fi
fi

# Pull latest changes
print_section "ğŸ“¥ Pulling Latest Changes"
git pull origin $CURRENT_BRANCH
print_success "Up to date with remote"

# Run CI checks
print_section "ğŸ§ª Running CI Checks"
print_info "Running bin/ci to ensure everything passes..."
if ./bin/ci; then
  print_success "All CI checks passed"
else
  print_error "CI checks failed. Fix issues before releasing."
  exit 1
fi

# Get current version from CHANGELOG
CURRENT_VERSION=$(grep -m 1 '\[.*\]' CHANGELOG.md | sed -n 's/.*\[\([0-9]*\.[0-9]*\.[0-9]*\)\].*/\1/p')
if [ -z "$CURRENT_VERSION" ]; then
  print_warning "Could not detect current version from CHANGELOG.md"
  CURRENT_VERSION="0.0.0"
fi

print_info "Current version: $CURRENT_VERSION"

# Ask for new version
print_section "ğŸ“ Version Bump"
echo "Current version: $CURRENT_VERSION"
echo ""
echo "Release type:"
echo "  1) Patch (bug fixes)         - e.g., 0.1.0 â†’ 0.1.1"
echo "  2) Minor (new features)      - e.g., 0.1.1 â†’ 0.2.0"
echo "  3) Major (breaking changes)  - e.g., 0.2.0 â†’ 1.0.0"
echo "  4) Custom version"
echo ""
read -p "Select release type (1-4): " RELEASE_TYPE

IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
MAJOR="${VERSION_PARTS[0]}"
MINOR="${VERSION_PARTS[1]}"
PATCH="${VERSION_PARTS[2]}"

case $RELEASE_TYPE in
  1)
    PATCH=$((PATCH + 1))
    NEW_VERSION="$MAJOR.$MINOR.$PATCH"
    ;;
  2)
    MINOR=$((MINOR + 1))
    PATCH=0
    NEW_VERSION="$MAJOR.$MINOR.$PATCH"
    ;;
  3)
    MAJOR=$((MAJOR + 1))
    MINOR=0
    PATCH=0
    NEW_VERSION="$MAJOR.$MINOR.$PATCH"
    ;;
  4)
    read -p "Enter custom version (e.g., 1.0.0): " NEW_VERSION
    if ! [[ $NEW_VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      print_error "Invalid version format. Must be X.Y.Z"
      exit 1
    fi
    ;;
  *)
    print_error "Invalid selection"
    exit 1
    ;;
esac

print_info "New version will be: $NEW_VERSION"

# Get release notes
print_section "ğŸ“‹ Release Notes"
echo "Enter release notes (what's new in this version?)"
echo "Press Ctrl+D when done, or Ctrl+C to cancel"
echo ""
RELEASE_NOTES=$(cat)

if [ -z "$RELEASE_NOTES" ]; then
  print_error "Release notes cannot be empty"
  exit 1
fi

# Confirm release
print_section "ğŸ” Review Release"
echo "Version: $NEW_VERSION"
echo ""
echo "Release Notes:"
echo "$RELEASE_NOTES"
echo ""
read -p "Create this release? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  print_info "Release cancelled"
  exit 1
fi

# Update CHANGELOG.md
print_section "ğŸ“ Updating CHANGELOG.md"
TODAY=$(date +%Y-%m-%d)

# Create new changelog entry
NEW_ENTRY="## [$NEW_VERSION] - $TODAY

$RELEASE_NOTES
"

# Insert after [Unreleased] section
sed -i "/## \[Unreleased\]/a\\
\\
$NEW_ENTRY" CHANGELOG.md

print_success "CHANGELOG.md updated"

# Commit changelog
print_info "Committing changelog..."
git add CHANGELOG.md
git commit -m "Release $NEW_VERSION

$RELEASE_NOTES

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

print_success "Changelog committed"

# Create git tag
print_section "ğŸ·ï¸  Creating Git Tag"
git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION

$RELEASE_NOTES"
print_success "Tag v$NEW_VERSION created"

# Push to GitHub
print_section "ğŸ“¤ Pushing to GitHub"
print_info "Pushing commits and tags..."
git push origin $CURRENT_BRANCH
git push origin "v$NEW_VERSION"
print_success "Pushed to GitHub"

# Create GitHub release
print_section "ğŸš€ Creating GitHub Release"
print_info "Creating release on GitHub..."

# Format release notes for GitHub
GITHUB_RELEASE_NOTES="$RELEASE_NOTES

---

## Installation

\`\`\`bash
# Via Claude Code plugin
/plugin marketplace add zerobearing2/rails-ai
/plugin install rails-ai
\`\`\`

## What's Changed

See [CHANGELOG.md](https://github.com/zerobearing2/rails-ai/blob/master/CHANGELOG.md) for full details.

**Full Changelog**: https://github.com/zerobearing2/rails-ai/compare/v$CURRENT_VERSION...v$NEW_VERSION"

gh release create "v$NEW_VERSION" \
  --title "v$NEW_VERSION" \
  --notes "$GITHUB_RELEASE_NOTES" \
  --latest

print_success "GitHub release created"

# Summary
print_section "âœ¨ Release Complete"
echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘     ğŸ‰ RELEASE v$NEW_VERSION COMPLETE     â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
print_success "Version: $NEW_VERSION"
print_success "Tag: v$NEW_VERSION"
print_success "CHANGELOG.md updated"
print_success "Pushed to GitHub"
print_success "GitHub release created"
echo ""
print_info "View release: https://github.com/zerobearing2/rails-ai/releases/tag/v$NEW_VERSION"
echo ""
