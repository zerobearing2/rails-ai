# CLAUDE.md - AI Development Context

**Project:** The Feedback Agent
**Status:** F-011 Complete - Multi-Step Feedback Submission Flow Ready
**Last Updated:** 2025-10-26
**Rails Version:** 8.1.0.rc1 (8-1-stable branch)

---

## Quick Context for AI Assistants

This document provides essential context for AI assistants (Claude, GPT-4, etc.) working on this Rails project. Read this first before making changes.

### AI Agent System

This project uses a **streamlined 8-agent team** where ALL requests route to `@rails` by default:

- **8 Specialized Agents**: `@rails` (architect), `@rails-frontend`, `@rails-backend`, `@rails-config`, `@rails-tests`, `@rails-design`, `@rails-debug`, `@rails-security`
- **Business User Role**: You define features and desired outcomes; architect asks clarifying questions
- **Plan First, Always**: Architect creates plans before delegating (saved to `docs/plans/`)
- **Autonomous Operation**: Team works independently with minimal human input
- **Parallel Execution**: Architect coordinates agents to work concurrently
- **Default Routing**: All requests automatically go to @rails architect first
- **TDD & Peer Review**: Frontend/backend use TDD, all agents peer review
- **37signals-Inspired**: Simple, pragmatic, conventional Rails development

**Quick Start:**
- Just state your request: `Add categories feature`
- Or explicit: `@rails - Add categories with filtering`
- Single agent: `@rails-backend - Add Category model`
- Let architect coordinate: `Implement email preferences` (auto-routes to @rails)

**Workflow:**
1. You (business user) provide feature request
2. Architect asks clarifying questions if needed
3. Architect creates plan â†’ `docs/plans/YYYY-MM-DD-feature-name.md`
4. Architect coordinates specialized agents
5. Architect validates work and updates plan
6. Deliverable to you with summary

ðŸ“– **See [AGENTS.md](AGENTS.md) for complete agent system documentation.**

ðŸ“– **See [.claude/TEAM_RULES.md](.claude/TEAM_RULES.md) for engineering standards and best practices.**

ðŸ“– **See [docs/plans/](docs/plans/) for implementation plans and decision logs.**

### What This Project Is

An anonymous feedback delivery system that enables constructive, private feedback between individuals via email. AI-powered content improvement and safety checks ensure feedback is helpful and appropriate.

**Key Features:**
- Anonymous feedback submission (no login required)
- AI content improvement (Claude Sonnet 4 / GPT-4)
- Email delivery via ActionMailer
- Recipient admin portal for reading/responding
- Rate limiting and abuse prevention
- Cookie-based visitor tracking

### Current Implementation Status

**âœ… COMPLETED:**
- **F-000**: Rails 8.1.0.rc1 setup with Solid Stack (SolidQueue, SolidCache, SolidCable)
- **F-007**: UI Component System with DaisyUI v5 + ViewComponent 4.1.0
  - 6 base UI components (Button, Card, FormField, Alert, Badge, Modal)
  - 2 domain-specific components (FeedbackSubmissionForm, FeedbackMessageCard)
  - 72 passing component tests
- **F-011**: Multi-Step Feedback Submission Flow v3.0 (Turbo Morph Architecture)
  - 5 new UI components (ProgressSteps, CharacterCounter, ProcessingStatus, MessageComparison, SuccessIcon)
  - AI service integration (Claude Sonnet 4.5 + GPT-4o fallback)
  - Email configuration (Resend SMTP)
  - 3 background jobs (ProcessFeedback, SendEmail, Cleanup)
  - 6 controller actions with status-based rendering
  - 7 views/partials with Turbo Stream subscription
  - 200+ new tests (component, model, job, controller, system)
  - Zero polling architecture with Turbo Morph auto-updates
  - Ready for production (pending API key setup)

**ðŸš§ IN PROGRESS / NOT YET STARTED:**
- F-002: Recipient Admin Portal (partially implemented)
- F-003: Email Notification System (implemented in F-011)
- F-004: Sender Tracking Portal (partially implemented)
- F-005: AI Content Processing (implemented in F-011)
- F-006: AI Review and Multi-Provider (implemented in F-011)
- F-008: Cookie Rate Limiting (partially implemented)
- F-009: Abuse Reporting (implemented)
- F-010: Kamal Deployment

### Tech Stack Quick Reference

| Technology | Version | Purpose |
|------------|---------|---------|
| Rails | 8.1.0.rc1 | Framework (8-1-stable branch) |
| Ruby | 3.3+ | Language |
| SQLite | 3.x | Database (primary, cache, queue, cable) |
| **ViewComponent** | **4.1.0** | **Component framework** |
| **DaisyUI** | **5.3.9** | **UI component library** |
| Tailwind CSS | v4 | Styling foundation |
| Hotwire | Latest | Turbo + Stimulus |
| Minitest | 5.x | Testing |
| SolidQueue | 1.x | Background jobs |
| SolidCache | 1.x | Caching |

**UI Approach:** ViewComponent + DaisyUI (Rails 8.1 compatible as of ViewComponent 4.1.0)

### Important Architecture Decisions

1. **ViewComponent + DaisyUI**: Modern component architecture with production-ready UI components
   - Base components in `app/components/ui/`
   - Domain components in `app/components/feedback_components/`
   - Tests in `test/components/`
   - Note: FeedbackComponents namespace avoids conflict with Feedback model

2. **Tailwind v4 + DaisyUI Integration**:
   ```css
   @import "tailwindcss";
   @plugin "daisyui";

   /* Custom utilities still use @utility directive */
   @utility btn {
     display: inline-flex;
     padding: 0.5rem 1rem;
   }
   ```

3. **All Config in Initializers**: Never modify `config/application.rb` or environment files. All custom config goes in `config/initializers/`.

4. **Multi-Database Setup**: 4 separate SQLite databases per environment (primary, cache, queue, cable).

5. **Rails 8.1 Rate Limiting**: Use built-in `rate_limit` DSL with SolidCache, not custom middleware.

### File Structure

```
feedback-app/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ controllers/          # Rails controllers
â”‚   â”œâ”€â”€ models/               # ActiveRecord models
â”‚   â”œâ”€â”€ components/           # ViewComponents
â”‚   â”‚   â”œâ”€â”€ ui/               # Base UI components (Button, Card, etc.)
â”‚   â”‚   â””â”€â”€ feedback_components/  # Domain-specific components
â”‚   â”œâ”€â”€ views/
â”‚   â”‚   â”œâ”€â”€ layouts/          # Application layouts
â”‚   â”‚   â””â”€â”€ [controllers]/    # Controller-specific views
â”‚   â”œâ”€â”€ helpers/              # View helpers
â”‚   â”œâ”€â”€ mailers/              # ActionMailer classes
â”‚   â”œâ”€â”€ jobs/                 # ActiveJob background jobs
â”‚   â””â”€â”€ assets/
â”‚       â””â”€â”€ tailwind/
â”‚           â””â”€â”€ application.css  # Tailwind v4 + DaisyUI config
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ initializers/         # All custom configuration
â”‚   â”‚   â”œâ”€â”€ solid_cache.rb
â”‚   â”‚   â”œâ”€â”€ solid_queue.rb
â”‚   â”‚   â”œâ”€â”€ action_mailer.rb
â”‚   â”‚   â””â”€â”€ view_component.rb  # ViewComponent config
â”‚   â”œâ”€â”€ database.yml          # Multi-database config
â”‚   â””â”€â”€ routes.rb
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ migrate/              # Migrations for primary DB
â”‚   â”œâ”€â”€ cache_migrate/        # Cache DB migrations
â”‚   â”œâ”€â”€ queue_migrate/        # Queue DB migrations
â”‚   â””â”€â”€ cable_migrate/        # Cable DB migrations
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ components/           # ViewComponent tests
â”‚   â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â””â”€â”€ feedback_components/
â”‚   â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ system/
â”œâ”€â”€ docs/                     # Specification documents
â”‚   â”œâ”€â”€ vision.md
â”‚   â”œâ”€â”€ architecture/
â”‚   â”œâ”€â”€ features/
â”‚   â””â”€â”€ tasks/
â””â”€â”€ storage/                  # SQLite database files
```

### Development Workflow

**Starting Development:**
```bash
bin/dev                # Start Rails + Tailwind watcher
```

**Running Tests:**
```bash
bin/ci                 # Full CI suite (must pass before commits)
rails test             # Run all tests
rails test test/components/  # Run component tests only
rails test:system      # Run system tests
```

**Database Operations:**
```bash
rails db:migrate       # Run all pending migrations (all 4 DBs)
rails db:reset         # Drop, create, migrate, seed
```

**Tailwind CSS:**
```bash
rails tailwindcss:build       # Compile CSS
rails tailwindcss:watch       # Watch mode (included in bin/dev)
```

### Code Style Guidelines & Team Rules

**ðŸ“– CRITICAL: Read [.claude/TEAM_RULES.md](.claude/TEAM_RULES.md) for complete engineering standards.**

**Ruby Style:**
- Follow RuboCop Rails Omakase (runs in bin/ci)
- Use double quotes for strings (not single quotes)
- 2-space indentation
- No trailing whitespace
- Be concise - self-documenting code

**Rails Conventions:**
- Use `form_with` for all forms (Turbo-compatible)
- Strong parameters in controllers
- Fat models, thin controllers (extract services only when needed)
- **REST routes only** - no custom actions (create child controllers)
- **Solid Stack only** - SolidQueue, SolidCache, SolidCable (no Sidekiq/Redis)

**ViewComponent + DaisyUI:**
- Use ViewComponents for all reusable UI elements
- Wrap DaisyUI classes in ViewComponents for consistency
- Component naming: `Ui::` for base UI, `FeedbackComponents::` for domain-specific
- Always write component tests with `ViewComponent::TestCase`

**Hotwire:**
- **Turbo Morph by default** - preserves scroll, focus, state
- Turbo Frames only for: modals, inline editing, pagination, tabs
- Stimulus for progressive enhancement

**Testing & TDD:**
- **TDD always** - Write tests first (RED-GREEN-REFACTOR)
- **Minitest only** - never RSpec
- Component tests for ViewComponents
- System tests for user flows
- 85%+ coverage goal
- Ensure bin/ci passes before committing

**Simplicity & Pragmatism:**
- Don't over-engineer - start simple
- Reduce complexity always - delete code
- No premature optimization
- Follow Rails conventions over custom solutions

### Common Tasks for AI Assistants

**Creating a New Feature:**
1. Check `docs/features/F-XXX-*.md` for specification
2. Check `docs/tasks/F-XXX-tasks.md` for task breakdown
3. Create models with `rails g model`
4. Create controllers with `rails g controller`
5. Create/use ViewComponents for UI
6. Add routes to `config/routes.rb`
7. Write tests in `test/`
8. Run `bin/ci` to verify
9. Commit with descriptive message

**Using Existing ViewComponents:**
```erb
<%# Button Component %>
<%= render Ui::ButtonComponent.new(variant: :primary, size: :lg) do %>
  Submit Feedback
<% end %>

<%# Card Component %>
<%= render Ui::CardComponent.new(variant: :bordered) do |card| %>
  <% card.with_title { "Card Title" } %>
  <% card.with_body { "Card content here" } %>
  <% card.with_actions do %>
    <%= render Ui::ButtonComponent.new(variant: :primary) { "Action" } %>
  <% end %>
<% end %>

<%# Form Field Component %>
<%= render Ui::FormFieldComponent.new(
  name: "feedback[content]",
  label: "Your Feedback",
  type: :textarea,
  required: true,
  hint: "Provide constructive feedback"
) %>

<%# Alert Component %>
<%= render Ui::AlertComponent.new(type: :success, dismissible: true) do %>
  Feedback sent successfully!
<% end %>

<%# Badge Component %>
<%= render Ui::BadgeComponent.new(variant: :success, size: :sm) do %>
  Active
<% end %>

<%# Domain-Specific: Feedback Submission Form %>
<%= render FeedbackComponents::SubmissionFormComponent.new(
  url: feedback_path,
  method: :post
) %>
```

**Creating a New ViewComponent:**
```ruby
# app/components/ui/example_component.rb
module Ui
  class ExampleComponent < ViewComponent::Base
    def initialize(variant: :default, **options)
      @variant = variant
      @options = options
    end

    private

    attr_reader :variant, :options

    def component_classes
      ["base-class", "variant-#{variant}"].join(" ")
    end
  end
end
```

```erb
<%# app/components/ui/example_component.html.erb %>
<div class="<%= component_classes %>" <%= tag.attributes(options) %>>
  <%= content %>
</div>
```

```ruby
# test/components/ui/example_component_test.rb
require "test_helper"

class Ui::ExampleComponentTest < ViewComponent::TestCase
  def test_renders_with_default_variant
    render_inline(Ui::ExampleComponent.new) { "Content" }

    assert_selector ".base-class.variant-default", text: "Content"
  end
end
```

**Creating a Background Job:**
```ruby
# app/jobs/send_feedback_job.rb
class SendFeedbackJob < ApplicationJob
  queue_as :default

  def perform(feedback_id)
    # Job logic here
  end
end
```

**Creating a Mailer:**
```ruby
# app/mailers/feedback_mailer.rb
class FeedbackMailer < ApplicationMailer
  def notify_recipient(feedback)
    @feedback = feedback
    mail(to: feedback.recipient_email, subject: "New Anonymous Feedback")
  end
end
```

### Available ViewComponents

**Base UI Components (app/components/ui/):**
1. **ButtonComponent**: 9 variants, 4 sizes, loading/disabled states
2. **CardComponent**: Slot-based (title/body/actions), 4 variants, glass effect
3. **FormFieldComponent**: 10 field types, error/hint display
4. **AlertComponent**: 4 types, dismissible, built-in icons
5. **BadgeComponent**: 9 variants, 4 sizes
6. **ModalComponent**: 4 sizes, slot-based, dialog element

**Domain Components (app/components/feedback_components/):**
1. **SubmissionFormComponent**: Complete feedback form with AI toggle, character counter
2. **MessageCardComponent**: Display feedback with status, AI badge, response section

### What NOT to Do

âŒ **Don't modify config/application.rb** - Use initializers instead
âŒ **Don't use Sidekiq/Redis** - Use Solid Stack (SolidQueue, SolidCache, SolidCable)
âŒ **Don't use RSpec** - Use Minitest only
âŒ **Don't add custom route actions** - Use REST only, create child controllers
âŒ **Don't skip TDD** - Always write tests first
âŒ **Don't over-engineer** - Keep it simple, use Rails conventions
âŒ **Don't use Tailwind v3 syntax** - We're on v4 (`@utility` not `@apply`)
âŒ **Don't commit without running bin/ci** - All checks must pass
âŒ **Don't use single quotes** - RuboCop requires double quotes
âŒ **Don't create migrations without specifying database** - Multi-DB setup
âŒ **Don't use `Feedback::` namespace for components** - Use `FeedbackComponents::` to avoid model conflict
âŒ **Don't create new components without tests** - ViewComponent tests required
âŒ **Don't open PRs for review before ready** - Use draft PRs initially

**ðŸ“– See [.claude/TEAM_RULES.md](.claude/TEAM_RULES.md) for complete list and explanations.**

### Debugging Tips

**Rails Console:**
```bash
rails console
# Test cache: Rails.cache.write('test', 'value')
# Test jobs: SendFeedbackJob.perform_later(123)
# Test mailer: FeedbackMailer.notify_recipient(feedback).deliver_later
# Render component: Ui::ButtonComponent.new(variant: :primary).render_in(view_context)
```

**Logs:**
```bash
tail -f log/development.log    # Watch Rails logs
tail -f log/test.log           # Watch test logs
```

**Database:**
```bash
rails dbconsole                # SQLite console for primary DB
```

**Component Previews:**
- ViewComponent previews available at `/rails/view_components` in development
- Preview files in `test/components/previews/`

### Getting Help

**AI Agent System:**
- **[AGENTS.md](AGENTS.md)** - Complete agent system documentation (read this for multi-agent workflows)
- **[.claude/TEAM_RULES.md](.claude/TEAM_RULES.md)** - Engineering standards and best practices (37signals-inspired)

**Documentation:**
- Project specs: `docs/vision.md`, `docs/architecture/`
- Feature specs: `docs/features/F-*.md`
- Task breakdowns: `docs/tasks/F-*-tasks.md`
- Rails 8.1 guides: https://edgeguides.rubyonrails.org/
- Tailwind v4 docs: https://tailwindcss.com/docs/v4-beta
- DaisyUI docs: https://daisyui.com/
- ViewComponent docs: https://viewcomponent.org/

**Key Files to Reference:**
- **`.claude/TEAM_RULES.md`** - Engineering standards (Solid Stack, Minitest, REST-only, TDD, etc.)
- **`AGENTS.md`** - AI agent system guide (agents, MCP, workflows)
- `CLAUDE.md` - This file (project context and quick reference)
- `docs/vision.md` - Product vision and requirements
- `docs/architecture/tech-stack.md` - Technology decisions
- `docs/features/F-007-daisyui-viewcomponent.md` - Component system details

### Current Git Status

**Remote:** https://github.com/zerobearing2/feedback-app
**Branch:** feature/F-007-daisyui-viewcomponent (PR #18 open)
**Latest Commits:**
- 294e156 - F-007: Implement DaisyUI & ViewComponent UI System
- ee53d50 - Update F-007 specification and task breakdown
- 3 commits total on feature branch

**Git Workflow:**
1. Make changes
2. Run `bin/ci` (must pass)
3. Commit with descriptive message
4. Push to origin

### Next Steps

**Ready to implement:** F-001 - Feedback Submission Form
- Use `FeedbackComponents::SubmissionFormComponent` (already built!)
- See `docs/features/F-001-feedback-submission-form.md`
- See `docs/tasks/F-001-tasks.md` for breakdown
- Estimated: 12-16 hours

---

**For AI Assistants:** When you start a new session:
1. Read this file (`CLAUDE.md`) for project context and current status
2. Read `.claude/TEAM_RULES.md` for engineering standards and best practices
3. Read `AGENTS.md` for agent system documentation and multi-agent workflows
4. Check relevant feature/task documentation before making changes
5. Use the agent system (`@rails`, `@rails-frontend`, etc.) for coordinated development
6. **Always follow .claude/TEAM_RULES.md** - enforce Solid Stack, Minitest, REST-only, TDD, simplicity
7. **Plan first, always** - If you're the architect, create plans in `docs/plans/` before delegating
8. **Ask clarifying questions** - If requirements are unclear or vague, ask the business user
9. **Reference plans** - Check `docs/plans/` for context on ongoing or past work
