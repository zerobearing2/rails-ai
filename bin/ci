#!/usr/bin/env bash
# Rails AI CI Script
# Runs all linters and tests in Rails 8.1 style

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track overall success
OVERALL_SUCCESS=true

# Print section header
print_section() {
  echo ""
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo -e "${BLUE}$1${NC}"
  echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
}

# Print success message
print_success() {
  echo -e "${GREEN}âœ… $1${NC}"
}

# Print error message
print_error() {
  echo -e "${RED}âŒ $1${NC}"
  OVERALL_SUCCESS=false
}

# Print warning message
print_warning() {
  echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Print info message
print_info() {
  echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Check if we're in the right directory
if [ ! -f "Gemfile" ]; then
  print_error "Gemfile not found. Please run this script from the project root."
  exit 1
fi

# Welcome message
echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘       Rails AI - CI Pipeline              â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check if bundle is installed
if ! command -v bundle &> /dev/null; then
  print_error "Bundler not installed. Run: gem install bundler"
  exit 1
fi

# Install dependencies
print_section "ğŸ“¦ Installing Dependencies"
if bundle check &> /dev/null; then
  print_success "Dependencies already installed"
else
  print_info "Installing dependencies..."
  bundle install
  print_success "Dependencies installed"
fi

# ==============================================================================
# LINTING
# ==============================================================================

print_section "ğŸ” Running Linters"

# Run all linters via Rakefile (single source of truth)
print_info "Linting Ruby files with Rubocop..."
if bundle exec rake lint:ruby; then
  print_success "Ruby linting passed"
else
  print_error "Ruby linting failed"
  print_info "Run 'rake lint:fix' to auto-fix issues"
fi

print_info "Validating YAML front matter..."
if bundle exec rake lint:yaml; then
  print_success "YAML validation passed"
else
  print_error "YAML validation failed"
fi

print_info "Linting Markdown files..."
if bundle exec rake lint:markdown; then
  print_success "Markdown linting passed"
else
  print_error "Markdown linting failed"
fi

# ==============================================================================
# TESTING
# ==============================================================================

print_section "ğŸ§ª Running Tests"

# Unit tests (fast)
print_info "Running all unit tests (fast)..."
START_TIME=$(date +%s)
if bundle exec rake test:unit; then
  END_TIME=$(date +%s)
  DURATION=$((END_TIME - START_TIME))
  print_success "Unit tests passed in ${DURATION}s"
else
  print_error "Unit tests failed"
fi

# ==============================================================================
# TEST COVERAGE REPORT
# ==============================================================================

print_section "ğŸ“Š Test Coverage Report"
bundle exec rake test:report

# ==============================================================================
# SUMMARY
# ==============================================================================

print_section "ğŸ“‹ Summary"

if [ "$OVERALL_SUCCESS" = true ]; then
  echo ""
  echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${GREEN}â•‘           âœ… ALL CHECKS PASSED            â•‘${NC}"
  echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  print_success "Ready to commit!"
  exit 0
else
  echo ""
  echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${RED}â•‘          âŒ SOME CHECKS FAILED            â•‘${NC}"
  echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  print_error "Please fix the errors above before committing"

  # Helpful commands
  echo ""
  print_info "Helpful commands:"
  echo "  rake lint:fix                 # Auto-fix Ruby issues"
  echo "  rake test:file[path/to/test]  # Run specific test"
  echo "  rake test:unit                # Run all unit tests"
  echo "  rake test:unit:skills         # Run skill unit tests only"
  echo "  rake test:unit:commands       # Run command unit tests only"
  echo "  rake test:unit:rules          # Run rules unit tests only"
  echo ""

  exit 1
fi
